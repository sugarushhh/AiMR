<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>登录与绑定网易云</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f0f2f5;margin:0;padding:40px}
  .wrap{max-width:480px;margin:0 auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.08)}
  h2{margin:0 0 16px}
  input,button{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;margin-top:10px}
  button{background:#4f46e5;color:#fff;border:none;cursor:pointer}
  button:hover{opacity:.9}
  .card{margin-top:20px;padding:16px;border:1px dashed #ddd;border-radius:10px;background:#fafafa}
  pre{white-space:pre-wrap;background:#f7f7f7;padding:10px;border-radius:8px;max-height:220px;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
  <h2>1) 登录应用（Supabase 手机号 OTP）</h2>
  <div class="card">
    <input id="sp_phone" placeholder="手机号（含区号，如 +86... 或 1开头国内号也可尝试）" />
    <button onclick="sendSpOtp()">发送 Supabase 验证码</button>
    <input id="sp_code" placeholder="收到的验证码" />
    <button onclick="verifySpOtp()">验证并登录</button>
    <div id="sp_result"></div>
  </div>

  <h2>2) 绑定网易云账号（网易云短信验证码）</h2>
  <div class="card">
    <input id="ne_phone" placeholder="网易云手机号（国内直接 1 开头）" />
    <button onclick="sendNeCaptcha()">发送网易云验证码</button>
    <input id="ne_code" placeholder="网易云验证码" />
    <button onclick="bindNetease()">绑定网易云</button>
    <button onclick="checkNeStatus()">查询网易云登录状态</button>
    <pre id="ne_result"></pre>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://eiyaloehytwaralfqsrk.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpeWFsb2VoeXR3YXJhbGZxc3JrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMzk1MzYsImV4cCI6MjA3MDcxNTUzNn0.t6E4Ps8qRsukYJUFUJ7ZTuc3nmn0SeKlSFIUi2QcVKk";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = (id) => document.getElementById(id);

async function sendSpOtp() {
  const phone = $("sp_phone").value.trim();
  if (!phone) return alert("请输入手机号");
  const { data, error } = await supabase.auth.signInWithOtp({
    phone,
    options: { shouldCreateUser: true }
  });
  $("sp_result").innerText = error ? ("发送失败：" + error.message) : "验证码已发送";
}

async function verifySpOtp() {
  const phone = $("sp_phone").value.trim();
  const code = $("sp_code").value.trim();
  if (!phone || !code) return alert("请输入手机号与验证码");
  const { data, error } = await supabase.auth.verifyOtp({ phone, token: code, type: "sms" });
  $("sp_result").innerText = error ? ("登录失败：" + error.message) : "登录成功";
}

async function getToken() {
  const { data } = await supabase.auth.getSession();
  return data?.session?.access_token || null;
}

// 下面这些调用你部署在 Render 的后端接口（同域，无需 CORS）
async function sendNeCaptcha() {
  const token = await getToken();
  if (!token) return alert("请先完成上方 Supabase 登录");
  const phone = $("ne_phone").value.trim();
  if (!phone) return alert("请输入网易云手机号");

  const res = await fetch("/api/netease/send_captcha", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
      "Authorization": "Bearer " + token
    },
    body: `phone=${encodeURIComponent(phone)}`
  });
  const data = await res.json();
  $("ne_result").innerText = JSON.stringify(data, null, 2);
}

async function bindNetease() {
  const token = await getToken();
  if (!token) return alert("请先完成上方 Supabase 登录");
  const phone = $("ne_phone").value.trim();
  const code = $("ne_code").value.trim();
  if (!phone || !code) return alert("请输入网易云手机号与验证码");

  const res = await fetch("/api/netease/login", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
      "Authorization": "Bearer " + token
    },
    body: `phone=${encodeURIComponent(phone)}&captcha=${encodeURIComponent(code)}`
  });
  const data = await res.json();
  $("ne_result").innerText = JSON.stringify(data, null, 2);
}

async function checkNeStatus() {
  const token = await getToken();
  if (!token) return alert("请先完成上方 Supabase 登录");
  const res = await fetch("/api/netease/status", {
    headers: { "Authorization": "Bearer " + token }
  });
  const data = await res.json();
  $("ne_result").innerText = JSON.stringify(data, null, 2);
}
</script>
</body>
</html>
